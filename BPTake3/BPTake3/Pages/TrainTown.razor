@inject IJSRuntime JSRuntime


@page "/StepTwo"

<h3>Puzzle Two</h3>

<p>Congratulations on making it out! How did I know? I don't! This message will be awkward if we fail... </p>

<p>If he's not reading it, who cares! No one will know you talk to yourself. Wait... I think everyone already knows that. Oh well!</p>









<p>_his is not a drive by!<br />Just a shy guy looking for a two ply<br />Hefty bag won't hold myyyy love</p>

<p>With dr_ps of Jupiter in her ear</p>

<p>The _ay you move ain't fair you know<br />Hey Soul Sister</p>

<p>Followi_g the map that leads to you</p>

<p>Two words: _____ ____</p>

<button>Find your destination below</button>

@if (LocationFound)
{
    <button>Click me once you have finished this location's activity!</button>
}


@code {
    PositionData Position { get; set; } = new PositionData();
    private string? Latitude { get; set; }
    private string? Longitude { get; set; }
    private double Distance { get; set; }
    private string? ErrorMessage { get; set; }
    public bool LocationFound { get; set; }

    // ACTUAL: Starbucks nearby
    // private double TargetLatitude { get; set; } = 34.01919064639046;
    // private double TargetLongitude { get; set; } = -118.33475988714115;

    // TESTING: These are our leasing office
    private double TargetLatitude { get; set; } = 33.73789467162089;
    private double TargetLongitude { get; set; } = -117.76360090695829;


    private async Task GetLocationAsync()
    {
        Console.WriteLine("Button pressed!");
        await JSRuntime.InvokeVoidAsync("geolocationInterop.getCurrentPosition", DotNetObjectReference.Create(this));
        Distance = CalculateDistance(Position.Latitude, Position.Longitude, TargetLatitude, TargetLongitude);

        if (Distance < 0.1) LocationFound = true;
    }

    [JSInvokable]
    public void ReceivePosition(PositionData position)
    {
        Latitude = position.Latitude.ToString();
        Longitude = position.Longitude.ToString();
        Position.Latitude = position.Latitude;
        Position.Longitude = position.Longitude;
        Console.WriteLine("Location grabbed");
    }

    [JSInvokable]
    public void ReceiveError(string message)
    {
        ErrorMessage = $"Error retrieving location: {message}";
        LocationFound = false;
    }

    public class PositionData
    {
        public double Latitude { get; set; }
        public double Longitude { get; set; }
    }

    private double CalculateDistance(double lat1, double lon1, double lat2, double lon2)
    {
        const double R = 6371; // Radius of Earth in kilometers
        var dLat = ToRadians(lat2 - lat1);
        var dLon = ToRadians(lon2 - lon1);

        var a = Math.Sin(dLat / 2) * Math.Sin(dLat / 2) +
                Math.Cos(ToRadians(lat1)) * Math.Cos(ToRadians(lat2)) *
                Math.Sin(dLon / 2) * Math.Sin(dLon / 2);

        var c = 2 * Math.Atan2(Math.Sqrt(a), Math.Sqrt(1 - a));
        return Math.Round(R * c * 0.621371, 2);
    }

    private double ToRadians(double deg) => deg * Math.PI / 180;
}

